<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title th:text="${venta.id == null} ? 'Nueva Venta' : 'Editar Venta'">Venta</title>
</head>
<body class="min-h-screen flex flex-col">
    <nav th:replace="~{fragments/layout :: navbar}"></nav>

    <main class="flex-1 p-6">
        <div class="container max-w-4xl mx-auto">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-3xl font-bold" th:text="${venta.id == null} ? 'Nueva Venta' : 'Editar Venta'"></h1>
                <p style="color: var(--muted-foreground);">Completa los datos de la venta</p>
            </div>

            <!-- Formulario -->
            <div class="card">
                <form th:action="${venta.id != null ? '/ventas/editar/' + venta.id : '/ventas'}" th:object="${venta}" method="post" class="card-content space-y-4">
                    <input type="hidden" th:field="*{id}"/>

                    <!-- Información del cliente -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3">Información del Cliente</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Cliente *</label>
                                <select th:field="*{cliente.id}" class="form-select" required>
                                    <option value="">Seleccionar cliente</option>
                                    <option th:each="cliente : ${clientes}" 
                                            th:value="${cliente.id}" 
                                            th:text="${cliente.nombre + ' ' + cliente.primerApellido + ' ' + cliente.segundoApellido}">
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Fecha *</label>
                                <input type="datetime-local" 
                                       name="fecha"
                                       th:value="${venta.fecha != null ? #temporals.format(venta.fecha, 'yyyy-MM-dd''T''HH:mm') : ''}"
                                       th:attr="max=${maxDate}"
                                       class="form-input" required/>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje -->
                    <div>
                        <label class="form-label">Mensaje</label>
                        <textarea th:field="*{mensaje}" class="form-textarea" rows="3" placeholder="Mensaje adicional (opcional)"></textarea>
                    </div>

                    <!-- Productos -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold">Productos</h4>
                            <button type="button" onclick="addProductLine()" class="btn btn-secondary btn-sm">
                                <i class="fa-solid fa-plus icon"></i>
                                Agregar Producto
                            </button>
                        </div>
                        <div id="productLines">
                            <!-- Productos existentes (solo en edición) -->
                            <div th:if="${venta.id != null and detallesExistentes != null and !detallesExistentes.isEmpty()}">
                                <div th:each="detalle, iterStat : ${detallesExistentes}"
                                     th:id="'productLine' + (${iterStat.index + 1})"
                                     class="grid grid-cols-12 gap-2 items-end mb-3 p-3 border rounded-lg bg-blue-50">

                                    <div class="col-span-5">
                                        <label class="form-label">Producto</label>
                                        <select class="form-select"
                                                th:id="'product' + (${iterStat.index + 1})"
                                                name="productoIds"
                                                th:onchange="'updatePrice(' + (${iterStat.index + 1}) + ')'" >
                                            <option value="">Seleccionar producto</option>
                                            <option th:each="producto : ${productos}"
                                                    th:value="${producto.id}"
                                                    th:selected="${producto.id == detalle.producto.id}"
                                                    th:data-price="${producto.precioDetalle}"
                                                    th:text="${producto.nombre}">
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col-span-2">
                                        <label class="form-label">Precio</label>
                                        <input type="number" class="form-input" step="0.01" readonly
                                               name="precios" th:id="'price' + (${iterStat.index + 1})"
                                               th:value="${detalle.precioVentaUnidad}">
                                    </div>

                                    <div class="col-span-2">
                                        <label class="form-label">Cantidad</label>
                                        <input type="number" class="form-input" min="1"
                                               th:id="'quantity' + (${iterStat.index + 1})"
                                               th:value="${detalle.cantidad}"
                                               th:onchange="'updateLineTotal(' + (${iterStat.index + 1}) + ')' "
                                               name="cantidades">
                                    </div>

                                    <div class="col-span-2">
                                        <label class="form-label">Subtotal</label>
                                        <input type="number" class="form-input" step="0.01" readonly
                                               th:id="'subtotal' + (${iterStat.index + 1})"
                                               th:value="${#numbers.formatDecimal(detalle.cantidad * detalle.precioVentaUnidad, 1, 2)}">
                                    </div>

                                    <div class="col-span-1">
                                        <button type="button"
                                                th:onclick="'removeProductLine(' + (${iterStat.index + 1}) + ', ' + ${detalle.id.idProducto} + ')'"
                                                class="btn btn-outline btn-sm" style="color: #dc2626;">
                                            <i class="fa-solid fa-xmark icon"></i>
                                        </button>
                                    </div>

                                </div>
                            </div>
                            <!-- Las líneas de productos nuevos se agregarán aquí -->
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="p-4 bg-gray-50 rounded-lg mb-4">
                        <div class="text-right">
                            <div class="text-lg font-semibold">
                                Total: ₡<span id="totalAmount">0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="flex justify-end gap-4 pt-4">
                        <a th:href="@{/ventas}" class="btn btn-outline">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Guardar Venta</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/layout :: footer}"></footer>

    <!-- Product data for JavaScript -->
    <div id="productData" th:data-productos="${productosJson}" style="display: none;"></div>

    <script>
        let productLineCounter = 0;
        let availableProducts = [];

        // Load products from data attribute
        function loadProducts() {
            const productDataElement = document.getElementById('productData');
            if (productDataElement) {
                const productData = productDataElement.getAttribute('data-productos');
                console.log('Raw product data:', productData);
                if (productData) {
                    try {
                        availableProducts = JSON.parse(productData);
                        console.log('Parsed products:', availableProducts);
                    } catch (e) {
                        console.error('Error parsing product data:', e);
                        availableProducts = [];
                    }
                } else {
                    console.error('No product data found');
                }
            } else {
                console.error('Product data element not found');
            }
        }

        function addProductLine() {
            productLineCounter++;
            const container = document.getElementById('productLines');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'grid grid-cols-12 gap-2 items-end mb-3 p-3 border rounded-lg';
            lineDiv.id = `productLine${productLineCounter}`;

            console.log('Adding product line, available products:', availableProducts);

            // Build options HTML
            let optionsHtml = '<option value="">Seleccionar producto</option>';
            if (availableProducts && availableProducts.length > 0) {
                availableProducts.forEach(function(product) {
                    console.log('Processing product:', product);
                    optionsHtml += `<option value="${product.id}" data-price="${product.precioDetalle}">${product.nombre}</option>`;
                });
            } else {
                console.warn('No products available for selection');
            }

            lineDiv.innerHTML = `
                <div class="col-span-5">
                    <label class="form-label">Producto</label>
                    <select class="form-select" onchange="updatePrice(${productLineCounter})" name="productoIds" id="product${productLineCounter}">
                        ${optionsHtml}
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="form-label">Precio</label>
                    <input type="number" class="form-input" step="0.01" readonly name="precios" id="price${productLineCounter}">
                </div>
                <div class="col-span-2">
                    <label class="form-label">Cantidad</label>
                    <input type="number" class="form-input" min="1" value="1" onchange="updateLineTotal(${productLineCounter})" name="cantidades" id="quantity${productLineCounter}">
                </div>
                <div class="col-span-2">
                    <label class="form-label">Subtotal</label>
                    <input type="number" class="form-input" step="0.01" readonly id="subtotal${productLineCounter}">
                </div>
                <div class="col-span-1">
                    <button type="button" onclick="removeProductLine(${productLineCounter})" class="btn btn-outline btn-sm" style="color: #dc2626;">
                        <i class="fa-solid fa-xmark icon"></i>
                    </button>
                </div>
            `;

            container.appendChild(lineDiv);
        }

        function removeProductLine(lineId, productId = null) {
            console.log('removeProductLine called with:', lineId, productId);
            const line = document.getElementById(`productLine${lineId}`);
            console.log('Found line element:', line);
            
            if (line) {
                // If this is an existing product (has productId), mark it for deletion
                if (productId) {
                    const form = document.querySelector('form');
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'productosAEliminar';
                    hiddenInput.value = productId;
                    form.appendChild(hiddenInput);
                    console.log('Marked existing product for deletion:', productId);
                }
                
                line.remove();
                updateTotal();
                console.log('Product line removed successfully');
            } else {
                console.error('Could not find product line with ID:', `productLine${lineId}`);
            }
        }

        function updatePrice(lineId) {
            const select = document.getElementById(`product${lineId}`);
            const priceInput = document.getElementById(`price${lineId}`);
            const selectedOption = select.options[select.selectedIndex];

            if (selectedOption.value) {
                priceInput.value = selectedOption.dataset.price;
                updateLineTotal(lineId);
            } else {
                priceInput.value = '';
                document.getElementById(`subtotal${lineId}`).value = '';
                updateTotal();
            }
        }

        function updateLineTotal(lineId) {
            const price = parseFloat(document.getElementById(`price${lineId}`).value) || 0;
            const quantity = parseInt(document.getElementById(`quantity${lineId}`).value) || 0;
            const subtotal = price * quantity;

            document.getElementById(`subtotal${lineId}`).value = subtotal.toFixed(2);
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            const subtotalInputs = document.querySelectorAll('[id^="subtotal"]');

            subtotalInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });

            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }


        // Add initial product line when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            
            // Count existing product lines and set counter accordingly
            const existingLines = document.querySelectorAll('#productLines .grid.grid-cols-12');
            productLineCounter = existingLines.length;
            
            // Only add initial product line if not editing (no existing products)
            if (productLineCounter === 0) {
                addProductLine();
            } else {
                // Update totals for existing products
                updateTotal();
            }
        });
    </script>
</body>
</html>
